{% extends "base.html" %}
{% load i18n static %}
{% block content %}
<link rel="stylesheet" href="{% static 'css/checkout.css' %}">

<div class="container py-4 checkout-container">
  <div class="row">
    <!-- Shipping -->
    <div class="col-md-8">
      <h4 class="mb-3">{% trans "Select shipping provider" %}</h4>
      <div class="d-flex gap-3 flex-wrap">
        <label class="shipping-option">
          <input type="radio" name="shipping" value="sendcloud" data-cost="4.90" checked>
          <span><img src="{% static 'img/sendcloud.png' %}" alt="Sendcloud" height="30"></span>
        </label>
        <label class="shipping-option">
          <input type="radio" name="shipping" value="ups" data-cost="7.90" disabled>
          <span><img src="{% static 'img/ups.png' %}" alt="UPS" height="30"></span>
        </label>
        <label class="shipping-option">
          <input type="radio" name="shipping" value="fedex" data-cost="8.90" disabled>
          <span><img src="{% static 'img/fedex.png' %}" alt="FedEx" height="30"></span>
        </label>
        <label class="shipping-option">
          <input type="radio" name="shipping" value="gls" data-cost="6.90" disabled>
          <span><img src="{% static 'img/gls.png' %}" alt="GLS" height="30"></span>
        </label>
      </div>
    </div>

    <!-- Shipping image -->
    <div class="col-md-4 text-center">
      <img src="{% static 'img/shipping.jpg' %}" alt="Shipping" class="img-fluid rounded shadow-sm">
    </div>
  </div>

  <hr>

  <!-- Order Summary -->
  <div class="row mt-4">
    <div class="col-md-8">
      <h4>{% trans "Finalize your order" %}</h4>
      <table class="table">
        <thead>
          <tr>
            <th>{% trans "Product" %}</th>
            <th>{% trans "Quantity" %}</th>
            <th>{% trans "Price" %}</th>
          </tr>
        </thead>
        <tbody id="order-items">
          {% for p, qty, line in items %}
          <tr>
            <td>{{ p.name }}</td>
            <td>{{ qty }}</td>
            <td>â‚¬{{ line|floatformat:2 }}</td>
          </tr>
          {% endfor %}
          <tr>
            <td>{% trans "Shipping" %}</td>
            <td>1</td>
            <td id="shipping-cost">â‚¬4.90</td>
          </tr>
          <tr>
            <td colspan="2">{% trans "Subtotal" %}</td>
            <!-- Subtotal = order.total_amount + shipping -->
            <td id="subtotal">â‚¬0.00</td>
          </tr>
          <tr>
            <td colspan="2">IVA (21%)</td>
            <td id="tax">â‚¬0.00</td>
          </tr>
          <tr class="fw-bold">
            <td colspan="2">{% trans "Total (EUR)" %}</td>
            <td id="total">â‚¬0.00</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Payment methods -->
    <div class="col-md-4">
      <h4>{% trans "Payment methods" %}</h4>

      <!-- Crypto Wallet -->
      <div class="payment-box mb-3">
        <strong>Cripto Wallet</strong>
        <button id="quoteBtn" class="btn btn-outline-secondary w-100 mt-2">
          {% trans "Get quote (ETH Sepolia)" %}
        </button>
        <div id="quoteBox" class="quote-box"></div>
        <button id="payBtn" class="btn btn-primary w-100 mt-2" disabled>
          {% trans "Pay with MetaMask" %}
        </button>
        <div id="payResult" class="mt-2 small text-muted"></div>
      </div>

            <!-- Stripe -->
      <div class="payment-box mb-3">
        <form method="post" action="{% url 'payments:stripe_checkout' order.id %}">
          {% csrf_token %}
          <button type="submit" class="btn p-0 border-0 w-100">
            <img src="{% static 'img/pay-cart-img.png' %}" alt="Stripe" class="img-fluid">
          </button>
        </form>
      </div>

      <!-- PayPal -->
      <div class="payment-box mb-3">
        <button type="button" class="btn p-0 border-0 w-100">
          <img src="{% static 'img/PayPal-img.png' %}" alt="PayPal" class="img-fluid">
        </button>
      </div>

      <!-- Revolut -->
      <div class="payment-box">
        <button type="button" class="btn p-0 border-0 w-100">
          <img src="{% static 'img/pay-revolut-img.png' %}" alt="Revolut" class="img-fluid">
        </button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/ethers@6.11.1/dist/ethers.umd.min.js"></script>
<script>
 window.orderId = {{ order.id }};
  window.orderTotal = {{ total|floatformat:2 }};  // ðŸ‘ˆ total de productos (backend)
  window.urls = {
    createQuote: "{% url 'orders:create_quote' order.id %}",
    validatePayment: "{% url 'orders:validate_payment' %}",
    confirmPayment: "{% url 'orders:confirm_payment' %}",
    confirmPage: "{% url 'orders:confirm' %}"
  };
</script>
<script src="{% static 'js/checkout.js' %}"></script>
{% endblock %}
